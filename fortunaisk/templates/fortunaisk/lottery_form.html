{% extends "fortunaisk/base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}
    {% if is_auto_lottery %}
        {% trans "Create Automatic Lottery" %}
    {% else %}
        {% trans "Create New Lottery" %}
    {% endif %}
{% endblock page_title %}

{% block details %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Carte principale -->
            <div class="card shadow-lg">
                <!-- En-tête -->
                <div class="card-header {% if is_auto_lottery %}bg-success{% else %}bg-primary{% endif %} text-white py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas {% if is_auto_lottery %}fa-sync{% else %}fa-ticket-alt{% endif %} fa-2x me-3"></i>
                        <div>
                            <h4 class="mb-0">
                                {% if is_auto_lottery %}
                                    {% trans "Create Automatic Lottery" %}
                                {% else %}
                                    {% trans "Create New Lottery" %}
                                {% endif %}
                            </h4>
                            <small class="opacity-75">
                                {% if is_auto_lottery %}
                                    {% trans "Set up a recurring lottery that runs automatically" %}
                                {% else %}
                                    {% trans "Create a one-time lottery event" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Corps du formulaire -->
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Section 1: Informations de Base -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <h5 class="mb-0">{% trans "Basic Information" %}</h5>
                            </div>

                            <div class="row g-3">
                                {% if is_auto_lottery %}
                                <!-- Nom (Auto Lottery uniquement) -->
                                <div class="col-md-6">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {% trans "Lottery Name" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                        {{ form.name }}
                                    </div>
                                    {% if form.name.errors %}
                                        <div class="text-danger mt-1">{{ form.name.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Fréquence -->
                                <div class="col-md-6">
                                    <label class="form-label">{% trans "Frequency" %}*</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        {{ form.frequency }}
                                        {{ form.frequency_unit }}
                                    </div>
                                    {% if form.frequency.errors %}
                                        <div class="text-danger mt-1">{{ form.frequency.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Prix du ticket -->
                                <div class="col-md-6">
                                    <label for="{{ form.ticket_price.id_for_label }}" class="form-label">
                                        {% trans "Ticket Price (ISK)" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-coins"></i></span>
                                        {{ form.ticket_price }}
                                        <span class="input-group-text">ISK</span>
                                    </div>
                                    {% if form.ticket_price.errors %}
                                        <div class="text-danger mt-1">{{ form.ticket_price.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Date de fin ou Durée -->
                                <div class="col-md-6">
                                    {% if is_auto_lottery %}
                                    <label for="{{ form.duration_hours.id_for_label }}" class="form-label">
                                        {% trans "Duration (Hours)" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-hourglass-half"></i></span>
                                        {{ form.duration_hours }}
                                        <span class="input-group-text">{% trans "Hours" %}</span>
                                    </div>
                                    {% if form.duration_hours.errors %}
                                        <div class="text-danger mt-1">{{ form.duration_hours.errors|striptags }}</div>
                                    {% endif %}
                                    {% else %}
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                        {% trans "End Date" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        {{ form.end_date }}
                                    </div>
                                    <div class="form-text">{% trans "Format: YYYY-MM-DD HH:MM" %}</div>
                                    {% if form.end_date.errors %}
                                        <div class="text-danger mt-1">{{ form.end_date.errors|striptags }}</div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Configuration des Gagnants -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-trophy text-warning me-2"></i>
                                <h5 class="mb-0">{% trans "Winners Configuration" %}</h5>
                            </div>

                            <div class="row g-3">
                                <!-- Récepteur des paiements -->
                                <div class="col-md-6">
                                    <label for="{{ form.payment_receiver.id_for_label }}" class="form-label">
                                        {% trans "Payment Receiver" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        {{ form.payment_receiver }}
                                    </div>
                                    {% if form.payment_receiver.errors %}
                                        <div class="text-danger mt-1">{{ form.payment_receiver.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Nombre de gagnants -->
                                <div class="col-md-6">
                                    <label for="{{ form.winner_count.id_for_label }}" class="form-label">
                                        {% trans "Number of Winners" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        {{ form.winner_count }}
                                    </div>
                                    {% if form.winner_count.errors %}
                                        <div class="text-danger mt-1">{{ form.winner_count.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Distribution des gains -->
                                <div class="col-12">
                                    <label for="{{ form.winners_distribution_str.id_for_label }}" class="form-label">
                                        {% trans "Prize Distribution" %}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-percent"></i></span>
                                        {{ form.winners_distribution_str }}
                                    </div>
                                    <div class="form-text">{{ form.winners_distribution_str.help_text }}</div>
                                    {% if form.winners_distribution_str.errors %}
                                        <div class="text-danger mt-1">{{ form.winners_distribution_str.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Paramètres Additionnels -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-cog text-secondary me-2"></i>
                                <h5 class="mb-0">{% trans "Additional Settings" %}</h5>
                            </div>

                            <div class="row g-3">
                                <!-- Limite de tickets par utilisateur -->
                                <div class="col-md-6">
                                    <label for="{{ form.max_tickets_per_user.id_for_label }}" class="form-label">
                                        {% trans "Max Tickets Per User" %}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-ticket-alt"></i></span>
                                        {{ form.max_tickets_per_user }}
                                    </div>
                                    {% if form.max_tickets_per_user.errors %}
                                        <div class="text-danger mt-1">{{ form.max_tickets_per_user.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                {% if is_auto_lottery %}
                                <!-- Statut actif (Auto Lottery uniquement) -->
                                <div class="col-md-6 d-flex align-items-center">
                                    <div class="form-check form-switch">
                                        {{ form.is_active }}
                                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                            {% trans "Enable Automatic Lottery" %}
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% if is_auto_lottery %}{% url 'fortunaisk:auto_lottery_list' %}{% else %}{% url 'fortunaisk:lottery' %}{% endif %}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>{% trans "Back" %}
                            </a>
                            <button type="submit" class="btn btn-lg {% if is_auto_lottery %}btn-success{% else %}btn-primary{% endif %}">
                                <i class="fas {% if is_auto_lottery %}fa-sync{% else %}fa-plus{% endif %} me-2"></i>
                                {% if is_auto_lottery %}
                                    {% trans "Create Automatic Lottery" %}
                                {% else %}
                                    {% trans "Create Lottery" %}
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script de validation côté client -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation du formulaire
    const form = document.querySelector('form');
    const winnerCountInput = document.getElementById('id_winner_count');
    const distributionInput = document.getElementById('id_winners_distribution_str');

    // Fonction de validation de la distribution des gagnants
    function validateDistribution(distribution) {
        if (!distribution) return false;

        const numbers = distribution.split(',').map(n => parseInt(n.trim()));
        if (numbers.some(isNaN)) return false;

        const sum = numbers.reduce((a, b) => a + b, 0);
        return sum === 100;
    }

    // Mise à jour automatique du nombre de gagnants
    distributionInput.addEventListener('input', function() {
        if (this.value) {
            const count = this.value.split(',').length;
            winnerCountInput.value = count;
        }
    });

    // Validation avant soumission
    form.addEventListener('submit', function(event) {
        let isValid = true;

        // Vérification des champs requis
        form.querySelectorAll('input[required]').forEach(input => {
            if (!input.value) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        // Validation de la distribution des gagnants
        if (distributionInput.value && !validateDistribution(distributionInput.value)) {
            distributionInput.classList.add('is-invalid');
            if (!distributionInput.nextElementSibling?.classList.contains('invalid-feedback')) {
                const feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = 'La somme des pourcentages doit être égale à 100';
                distributionInput.parentNode.appendChild(feedback);
            }
            isValid = false;
        } else {
            distributionInput.classList.remove('is-invalid');
        }

        // Empêcher la soumission si le formulaire n'est pas valide
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
        }
    });

    // Formatage des nombres pour les champs de prix
    const priceInput = document.getElementById('id_ticket_price');
    if (priceInput) {
        priceInput.addEventListener('input', function() {
            let value = this.value.replace(/[^\d.]/g, '');
            if (value) {
                value = parseFloat(value).toFixed(2);
                this.value = value;
            }
        });
    }

    // Pour les loteries automatiques uniquement
    const frequencyInput = document.getElementById('id_frequency');
    const frequencyUnitSelect = document.getElementById('id_frequency_unit');
    if (frequencyInput && frequencyUnitSelect) {
        // Mise à jour de l'unité selon la fréquence
        frequencyInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value === 1) {
                frequencyUnitSelect.querySelectorAll('option').forEach(option => {
                    option.textContent = option.textContent.replace(/s$/, '');
                });
            } else {
                frequencyUnitSelect.querySelectorAll('option').forEach(option => {
                    if (!option.textContent.endsWith('s')) {
                        option.textContent += 's';
                    }
                });
            }
        });
    }
});
</script>
{% endblock details %}
