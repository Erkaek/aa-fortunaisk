<!-- fortunaisk/templates/fortunaisk/lottery_form.html -->
{% extends "fortunaisk/base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}
    {% if is_auto_lottery %}
        {% trans "Create Automatic Lottery" %}
    {% else %}
        {% trans "Create New Lottery" %}
    {% endif %}
{% endblock page_title %}

{% block details %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Carte principale -->
            <div class="card shadow-lg">
                <!-- En-tête -->
                <div class="card-header {% if is_auto_lottery %}bg-success{% else %}bg-primary{% endif %} text-white py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas {% if is_auto_lottery %}fa-sync{% else %}fa-ticket-alt{% endif %} fa-2x me-3"></i>
                        <div>
                            <h4 class="mb-0">
                                {% if is_auto_lottery %}
                                    {% trans "Create Automatic Lottery" %}
                                {% else %}
                                    {% trans "Create New Lottery" %}
                                {% endif %}
                            </h4>
                            <small class="opacity-75">
                                {% if is_auto_lottery %}
                                    {% trans "Set up a recurring lottery that runs automatically" %}
                                {% else %}
                                    {% trans "Create a one-time lottery event" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Corps du formulaire -->
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        {% if is_auto_lottery %}
                        <!-- Enable Automatic Lottery Switch -->
                        <div class="mb-4 p-3 bg-light rounded">
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch">
                                    {{ form.is_active }}
                                    <label class="form-check-label fs-5" for="{{ form.is_active.id_for_label }}">
                                        <i class="fas fa-power-off me-2 text-success"></i>
                                        {% trans "Enable Automatic Lottery" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Section 1: Informations de Base -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <h5 class="mb-0">{% trans "Basic Information" %}</h5>
                            </div>

                            <div class="row g-3">
                                {% if is_auto_lottery %}
                                <!-- Nom (Auto Lottery uniquement) -->
                                <div class="col-md-6">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {% trans "Lottery Name" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                        {{ form.name }}
                                    </div>
                                    {% if form.name.errors %}
                                        <div class="text-danger mt-1">{{ form.name.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Fréquence -->
                                <div class="col-md-6 frequency-section">
                                    <label class="form-label">{% trans "Frequency" %}*</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        {{ form.frequency }}
                                        {{ form.frequency_unit }}
                                    </div>
                                    {% if form.frequency.errors %}
                                        <div class="text-danger mt-1">{{ form.frequency.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Prix du ticket -->
                                <div class="col-md-6">
                                    <label for="{{ form.ticket_price.id_for_label }}" class="form-label">
                                        {% trans "Ticket Price (ISK)" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-coins"></i></span>
                                        {{ form.ticket_price }}
                                        <span class="input-group-text">ISK</span>
                                    </div>
                                    {% if form.ticket_price.errors %}
                                        <div class="text-danger mt-1">{{ form.ticket_price.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Date de fin ou Durée -->
                                <div class="col-md-6">
                                    {% if is_auto_lottery %}
                                    <label for="{{ form.duration_value.id_for_label }}" class="form-label">
                                        {% trans "Duration" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-hourglass-half"></i></span>
                                        {{ form.duration_value }}
                                        {{ form.duration_unit }}
                                    </div>
                                    {% if form.duration_value.errors %}
                                        <div class="text-danger mt-1">{{ form.duration_value.errors|striptags }}</div>
                                    {% endif %}
                                    {% else %}
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                        {% trans "End Date" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        {{ form.end_date }}
                                    </div>
                                    <div class="form-text">{% trans "Format: YYYY-MM-DD HH:MM" %}</div>
                                    {% if form.end_date.errors %}
                                        <div class="text-danger mt-1">{{ form.end_date.errors|striptags }}</div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Configuration des Gagnants -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-trophy text-warning me-2"></i>
                                <h5 class="mb-0">{% trans "Winners Configuration" %}</h5>
                            </div>

                            <div class="row g-3">
                                <!-- Récepteur des paiements (défini par défaut) -->
                                <div class="col-md-6">
                                    <label class="form-label">
                                        {% trans "Payment Receiver" %}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="number" class="form-control" value="{{ form.initial.payment_receiver }}" readonly>
                                    </div>
                                </div>

                                <!-- Nombre de gagnants -->
                                <div class="col-md-6">
                                    <label for="{{ form.winner_count.id_for_label }}" class="form-label">
                                        {% trans "Number of Winners" %}*
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        {{ form.winner_count }}
                                    </div>
                                    {% if form.winner_count.errors %}
                                        <div class="text-danger mt-1">{{ form.winner_count.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <!-- Distribution des gains -->
                                <div class="col-12">
                                    <label class="form-label">
                                        {% trans "Prize Distribution" %}
                                    </label>
                                    <div id="prize-distribution-container">
                                        <!-- Les champs de distribution des prix seront ajoutés dynamiquement ici -->
                                        {% for idx in range(form.instance.winner_count) %}
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">{% trans "Winner" %} {{ idx|add:"1" }}%</span>
                                            <input type="number" name="winners_distribution" class="form-control prize-distribution" value="{{ form.instance.winners_distribution|index:idx }}" min="0" max="100" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if form.winners_distribution.errors %}
                                        <div class="text-danger mt-1">{{ form.winners_distribution.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Paramètres Additionnels -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-cog text-secondary me-2"></i>
                                <h5 class="mb-0">{% trans "Additional Settings" %}</h5>
                            </div>

                            <div class="row g-3">
                                <!-- Limite de tickets par utilisateur (défini automatiquement) -->
                                <div class="col-md-6">
                                    <label class="form-label">
                                        {% trans "Max Tickets Per User" %}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-ticket-alt"></i></span>
                                        <input type="number" class="form-control" value="1" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% if is_auto_lottery %}{% url 'fortunaisk:auto_lottery_list' %}{% else %}{% url 'fortunaisk:lottery' %}{% endif %}"
                                class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>{% trans "Back" %}
                            </a>
                            <button type="submit" class="btn btn-lg {% if is_auto_lottery %}btn-success{% else %}btn-primary{% endif %}">
                                <i class="fas {% if is_auto_lottery %}fa-sync{% else %}fa-plus{% endif %} me-2"></i>
                                {% if is_auto_lottery %}
                                    {% trans "Create Automatic Lottery" %}
                                {% else %}
                                    {% trans "Create Lottery" %}
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script de gestion dynamique des gagnants et distribution des prix -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Constantes pour les éléments du formulaire
    const FORM_ELEMENTS = {
        form: document.querySelector('form'),
        winnerCount: document.getElementById('id_winner_count'),
        distributionContainer: document.getElementById('prize-distribution-container'),
        distributionInputs: document.querySelectorAll('.prize-distribution'),
    };

    // Messages d'erreur
    const ERROR_MESSAGES = {
        distribution: 'La somme des pourcentages doit être égale à 100',
        required: 'Ce champ est obligatoire'
    };

    // Classe utilitaire pour la validation
    class FormValidator {
        static validateDistribution(distributions) {
            if (!distributions || distributions.length === 0) return false;

            const numbers = distributions.map(n => parseInt(n.value.trim())).filter(n => !isNaN(n));

            const total = numbers.reduce((a, b) => a + b, 0);
            return total === 100;
        }

        static showError(element, message) {
            element.classList.add('is-invalid');
            if (!element.nextElementSibling?.classList.contains('invalid-feedback')) {
                const feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = message;
                element.parentNode.appendChild(feedback);
            }
        }

        static removeError(element) {
            element.classList.remove('is-invalid');
            const feedback = element.nextElementSibling;
            if (feedback?.classList.contains('invalid-feedback')) {
                feedback.remove();
            }
        }
    }

    // Gestionnaire pour les champs de distribution des prix
    class PrizeDistributionHandler {
        static createDistributionField(index, value=100) {
            const div = document.createElement('div');
            div.className = 'input-group mb-2';

            const prepend = document.createElement('span');
            prepend.className = 'input-group-text';
            prepend.textContent = `Winner ${index + 1} %`;

            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.max = '100';
            input.className = 'form-control prize-distribution';
            input.value = value;
            input.required = true;

            const append = document.createElement('span');
            append.className = 'input-group-text';
            append.textContent = '%';

            div.appendChild(prepend);
            div.appendChild(input);
            div.appendChild(append);

            return div;
        }

        static updateDistributionFields(count) {
            const container = FORM_ELEMENTS.distributionContainer;
            container.innerHTML = '';

            for(let i = 0; i < count; i++) {
                let value = 100 / count;
                if(i === count -1){
                    // Le dernier gagnant prend le reste pour s'assurer que la somme fait 100
                    value = 100 - (100 * (count -1)/ count);
                }
                const field = this.createDistributionField(i, value);
                container.appendChild(field);
            }
        }

        static getDistributionValues() {
            const inputs = container.querySelectorAll('.prize-distribution');
            const values = [];
            inputs.forEach(input => {
                const val = parseInt(input.value.trim());
                if(!isNaN(val)){
                    values.push(val);
                }
            });
            return values;
        }
    }

    // Gestionnaire pour le formatage des prix
    class PriceFormatter {
        static handleBlur(event) {
            const input = event.target;
            if (input.value) {
                input.value = parseFloat(input.value).toFixed(2);
            }
        }
    }

    // Initialisation des écouteurs d'événements
    function initializeEventListeners() {
        // Écouteur pour le changement du nombre de gagnants
        FORM_ELEMENTS.winnerCount?.addEventListener('input', function(e) {
            const count = parseInt(e.target.value);
            if(!isNaN(count) && count > 0){
                PrizeDistributionHandler.updateDistributionFields(count);
            } else {
                FORM_ELEMENTS.distributionContainer.innerHTML = '';
            }
        });

        // Initialiser les champs de distribution en fonction de la valeur initiale
        const initialCount = parseInt(FORM_ELEMENTS.winnerCount?.value) || 1;
        PrizeDistributionHandler.updateDistributionFields(initialCount);

        // Écouteur pour le formatage des prix
        const priceInput = document.getElementById('id_ticket_price');
        priceInput?.addEventListener('blur', PriceFormatter.handleBlur);

        // Validation du formulaire à la soumission
        FORM_ELEMENTS.form?.addEventListener('submit', function(event) {
            let isValid = true;

            // Validation des champs requis
            this.querySelectorAll('input[required]').forEach(input => {
                if (!input.value) {
                    FormValidator.showError(input, ERROR_MESSAGES.required);
                    isValid = false;
                } else {
                    FormValidator.removeError(input);
                }
            });

            // Validation de la distribution
            const distributions = FORM_ELEMENTS.distributionContainer.querySelectorAll('.prize-distribution');
            let distributionValues = [];
            distributions.forEach(input => {
                const val = parseInt(input.value.trim());
                if(isNaN(val) || val <0 || val >100){
                    FormValidator.showError(input, 'Veuillez entrer une valeur valide entre 0 et 100.');
                    isValid = false;
                } else {
                    FormValidator.removeError(input);
                    distributionValues.push(val);
                }
            });

            const total = distributionValues.reduce((a, b) => a + b, 0);
            if(total !== 100){
                alert(ERROR_MESSAGES.distribution);
                isValid = false;
                distributions.forEach(input => {
                    FormValidator.showError(input, ERROR_MESSAGES.distribution);
                });
            }

            if(!isValid){
                event.preventDefault();
                event.stopPropagation();
            } else {
                // Définir winners_distribution
                const distributionStr = distributionValues.join(',');
                const distributionInput = document.getElementById('id_winners_distribution');
                if(distributionInput){
                    distributionInput.value = distributionStr;
                }
            }
        });
    }

    // Initialisation
    initializeEventListeners();
});
</script>
{% endblock details %}
